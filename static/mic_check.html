<!DOCTYPE html>
<html>

<head>
    <title>Microphone Permission Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }

        button:hover {
            background: #5568d3;
        }

        .status {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            font-size: 16px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .level-display {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            color: #667eea;
        }
    </style>
</head>

<body>
    <h1>üé§ Microphone Permission Test</h1>

    <div class="status info" id="status">
        Click the button below to test microphone access
    </div>

    <button onclick="testMicrophone()">Test Microphone</button>

    <div class="level-display" id="level">-</div>

    <div id="details" style="text-align: left; margin-top: 30px;"></div>

    <script>
        let stream = null;
        let audioContext = null;
        let analyser = null;
        let monitoring = false;

        async function testMicrophone() {
            const statusEl = document.getElementById('status');
            const detailsEl = document.getElementById('details');
            const levelEl = document.getElementById('level');

            detailsEl.innerHTML = '';

            try {
                statusEl.className = 'status info';
                statusEl.textContent = 'üìã Requesting microphone permission...';

                // Request microphone access
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                statusEl.className = 'status success';
                statusEl.textContent = '‚úÖ Microphone permission granted!';

                // Get microphone info
                const tracks = stream.getAudioTracks();
                if (tracks.length > 0) {
                    detailsEl.innerHTML += `<p><strong>Microphone:</strong> ${tracks[0].label}</p>`;
                    detailsEl.innerHTML += `<p><strong>Device ID:</strong> ${tracks[0].getSettings().deviceId}</p>`;
                }

                // Setup audio analysis
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                detailsEl.innerHTML += `<p><strong>Audio Context:</strong> Created successfully</p>`;
                detailsEl.innerHTML += `<p><strong>Sample Rate:</strong> ${audioContext.sampleRate} Hz</p>`;

                // Start monitoring
                monitoring = true;
                monitorAudioLevel();

                detailsEl.innerHTML += `<p style="color: green;"><strong>‚úÖ Now monitoring audio levels - SPEAK INTO YOUR MICROPHONE!</strong></p>`;

            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå Error: ' + error.message;

                detailsEl.innerHTML += `<p style="color: red;"><strong>Error Details:</strong></p>`;
                detailsEl.innerHTML += `<p>${error.name}: ${error.message}</p>`;

                if (error.name === 'NotAllowedError') {
                    detailsEl.innerHTML += `<p><strong>Solution:</strong> You need to allow microphone access. Click the üé§ icon in the address bar and select "Allow".</p>`;
                } else if (error.name === 'NotFoundError') {
                    detailsEl.innerHTML += `<p><strong>Solution:</strong> No microphone found. Please connect a microphone and try again.</p>`;
                }
            }
        }

        function monitorAudioLevel() {
            if (!monitoring || !analyser) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const max = Math.max(...dataArray);

            const levelEl = document.getElementById('level');
            levelEl.textContent = Math.round(average);

            // Color based on level
            if (average > 15) {
                levelEl.style.color = '#28a745'; // Green - speaking
            } else if (average > 5) {
                levelEl.style.color = '#ffc107'; // Yellow - low sound
            } else {
                levelEl.style.color = '#dc3545'; // Red - silence
            }

            console.log(`üìä Average: ${Math.round(average)}, Max: ${max}`);

            requestAnimationFrame(monitorAudioLevel);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            monitoring = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>

</html>